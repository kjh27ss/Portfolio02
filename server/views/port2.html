<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .popup-category{
        display: none;
        position:fixed;
        top:100px;
        left:50%;
        transform:translateX(-50%);
        width:250px;
        padding:30px;
        border:1px solid #ededed;
        background:#fff;
        border-radius: 10px;
        box-shadow: 0 0 10px 0 rgba(0,0,0,0.2);
      }
    </style>
</head>
<body class="pageinfo">
    <div class="container">
      <h1 class="my-5 py-4 text-center">í˜ì´ì§€ ì„¤ì •</h1>
      <div class="d-flex justify-content-between my-5">
        <a href="/" class="btn btn-info">ëª©ë¡</a>
        <div class="btn-group">
          <button class="btn btn-primary addCategory">ì¹´í…Œê³ ë¦¬ ì„¤ì •</button>
          <a href="./write" class="btn btn-success">ë°ì´í„° ì…ë ¥</a>
        </div>
      </div>
      <div class="row">
        <!-- loop -->
        {% for rs in row %}
        <a href="./edit/{{rs.id}}" class="col-3 my-4">
          <div class="card">            
            {% for image in rs.img %}
              <img src="/portfolio/{{image}}" class="card-img-top" />                      
            {% endfor %}
            {% if image == '' %}
              <style>
                .card-body{
                  padding-top: 40px;
                }
              </style>
            {% endif %}
            <div class="card-body">
              <h3>{{rs.pagename}}</h3>
              <h1>{{rs.title}}</h1>
              <p>{{rs.content}}</p>
              {% for ani in rs.animated %}
                <p>{{ani}}</p>
              {% endfor %}
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>

    <div class="popup-category">
      <form name="category-form" action="/portfolio/category-update" id="category-update-form" method="post">
        <ul id="sortable" class="list-group">
          <!-- loop -->
          {% for cat in rs %}
          <li class="ui-state-default list-group-item py-3 d-flex align-items-center">
            <div class="col-11">
              <input type="text" name="category[]" value="{{cat.name}}" class="form-control"/>
            </div>
            <input type="hidden" name="cate_id[]" value="{{cat.id}}" />
            <div class="col-1 mx-1 text-center">
              <a href="#" class="btn-close del-category" data-id="{{cat.id}}"></a>
            </div>              
          </li>
          {% endfor %}
          <!-- loop -->
          
        </ul>
        <div class="d-flex pt-4 justify-content-between">
          <button type="button" class="btn btn-warning closebtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-info addbtn">ì¶”ê°€</button>
          <button type="button" class="btn btn-danger cate-update">ì „ì†¡</button>
        </div>
      </form>
    </div>
    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-bootstrap/0.5pre/js/jquery-ui-1.9.2.custom.min.js" integrity="sha512-/j/PhXKFsf5Gc8eMuXoUn1tBjDJthhC5kBpOBPlNyANs9vxbJ8DM/gsciQ4ykymnUtHuk0yedLnlpg7DPmjZZg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      $(function(){
        // showì— ê°’ì´ ìˆìœ¼ë©´
        {% if show %}
          $('.popup-category').fadeIn(400);
        {% endif %}

        const popup_update = $('.popup-category').html();
        const popup_insert = `
            <form name="category-form" id="category-form" action="/portfolio/category-write" method="post">
            <ul class="list-group">
              <li class="ui-state-default list-group-item py-3">
                <input type="text" name="category" value="" id="category" class="form-control"/>
                <input type="hidden" name="num" id="num" value="{{maxNum}}" />
              </li>
            </ul>
            <div class="d-flex pt-4 justify-content-between">
              <button class="btn btn-warning closebtn">ë‹«ê¸°</button>
              <button class="btn btn-danger updatebtn">ìˆ˜ì •</button>
              <button class="btn btn-info cate-write">ì „ì†¡</button>
            </div>
          </form>
          </div>
        `;


        $('.addCategory').click(function(){
          $('.popup-category').fadeIn(400);
        });

        $("#sortable").sortable();

        $(document).on('click','.closebtn', function(){
          $('.popup-category').fadeOut(400);
        });

        $(document).on('click', '.addbtn', function(){
          $('.popup-category').html(popup_insert);
        });
        
        $(document).on('click','.updatebtn',function(){
          $('.popup-category').html(popup_update);
          $("#sortable").sortable();
        });

        // ì‚­ì œ ë¬¼ì–´ë³´ê¸°
        $('.del-category').click(function(){
          if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
            return false;
          }
        });

        $(document).on('click','.cate-update',function(){
          const data = $("#category-update-form").serialize();
          
          $.ajax({
            type:'post',
            url:"/portfolio/category/update",
            dataType:'json',
            data:data,
            success:function(rs){
              if(rs == 1){
                alert("ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.href="/porfolio/list?show=show";
              }else{
                alert("ì—ëŸ¬ ë°œìƒ");
              }
            },
            error:function(err){
              console.error(err);
            }
          })
        });

        $(document).on('click', '.cate-write', function(){
          const category = $('#category').val();
          const num = Number($("#num").val())+1;
          $.ajax({
            url:'/portfolio/category/write',
            type:'post',
            dataType:'json',
            data:{category:category, num:num},
            success:function(rs){
              if(rs == 1){
                alert("ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                const addList = `
                  <li class="ui-state-default list-group-item py-3">
                    <div class="col-11">
                      <input type="text" name="category" value="${category}" class="form-control"/>
                    </div>
                    <input type="hidden" name="cate_id" value="${num}" />
                    <div class="col-1 mx-1 text-center">
                      <a href="#" class="btn-close"></a>
                    </div> 
                  </li>`;
                // $('.popup-category').html(popup_update).prepend(addList);
                // $("#sortable").sortable();
                location.reload();                               
              }
            },
            error:function(err){
              console.log(err);
            }
          })
        });        

        $(document).on('click','.del-category',function(e){
          e.preventDefault();
          const id = $(this).data("id");
          $.ajax({
            url:'/portfolio/category/del',
            type:'post',
            dataType:'json',
            data:{id:id},
            success:function(rs){
              const res = parseInt(rs);
              if(res > 0){
                alert("ì‚­ì œ!ğŸ¥³");
                location.href="/porfolio/list?show=show";
              }else{
                alert("ë¬¸ì œ ë°œìƒ!!!ğŸ¤¬");
              }
            }
          })
        })
      })
    </script>
</body>
</html>